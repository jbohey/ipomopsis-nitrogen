---
title: "Ipomopsis nitrogen experiments"
author: "Janelle Bohey, John Powers"
date: "`r Sys.Date()`"
output: 
  html_document:
    self_contained: no
    lib_dir: libs
    code_folding: hide
    toc: yes
    toc_float: TRUE 
editor_options: 
  chunk_output_type: console
---
<style type="text/css">
.main-container { max-width: 1000px; margin-left: 0; margin-right: auto; }
img{ max-width:200%; height: auto; }
td, th { padding : 6px }
</style>

```{r setup, include=FALSE}
library(reshape2)
library(tidyverse)
library(lubridate)
library(vegan)
library(knitr)
knitr::opts_chunk$set(comment="", cache=T, warning=F, message=F, 
                      fig.path = "plots/", dev="svglite", dev.args=list(fix_text_size=FALSE), fig.height=8, fig.width=8)
```

```{r read_scents}
exp1.verdicts <- read_csv("data/exp1_verdicts.csv")
load("data/exp1_data.rda") #loads exp1.data (Shimadzu output)
exp1.data <- exp1.data %>% left_join(select(exp1.verdicts, Filename = FileName, sample2)) %>% 
  select(-Filename) %>% rename(Filename = sample2) %>%  #replace FileName with the sample2 it holds (accounts for skips)
  droplevels()

exp1.all <- dcast(exp1.data, Filename~Name, sum, value.var="Area")
rownames(exp1.all) <- exp1.all[,1]
exp1.all[,1] <- NULL
```

# Read metadata

```{r metadata}
meta <- read_csv("data/EXP 1 (N) Volatile sampling  - metadata.csv") %>% 
  filter(filename != "#N/A") %>% 
  mutate(plantid = paste(species, plant)) %>% 
  left_join(read_csv("data/exp1_treatments.csv") %>% mutate(plant = as.character(plant)))
rownames(meta) <- meta$filename
meta <- meta[rownames(exp1.all),] #order meta to match order of data


meta %>% count(species, time)
meta %>% count(species, time, treatment)
meta %>% count(date, species, time)
meta %>% count(date, species, time)
meta %>% count(plantid, time)
```

# bouquet vingnette #

```{r}
# install packages 
#install.packages("remotes")
#remotes::install_github("jmpowers/bouquet", build_vignettes = TRUE)
library(bouquet)
#library(magrittr)
```

# Metadata

```{r}
GCMS_metadata <- meta %>% mutate(type= ifelse(species=="AMB", "ambient","floral")) %>% rename(trap=sample)

metadata <- load_metadata(GCMS_metadata, date = "date", 
                          sample = "filename", group = "treatment", 
                          type = "type")
```

# Long Data
```{r}
longdata <- load_longdata(exp1.data, sample = "Filename", RT = "Ret.Time", 
                          name = "Name", area = "Area", 
                          match = "SI", maxmatch=100)

```

#Sample Table
```{r}
sampletable <- make_sampletable(longdata, metadata)
```

#Chem Table
```{r}
chemtable <- make_chemtable(longdata, metadata)
save(chemtable, file="chemtable.rda")
```

```{r}
chemtable <- chemtable %>% 
  filter_RT(2, 19) %>% 
  filter_match(0.8) %>% 
  filter_freq(0.2, group = FALSE) %>% 
  filter_contaminant(cont.list = "Caprolactam") %>% 
  filter_area(min_maximum = 5e5) %>%
  filter_ambient_ratio(sampletable, metadata, ratio = 4) %>% 
  filter_ambient_ttest(sampletable, metadata, 
                       alpha = 0.05, adjust = "fdr")
```

